<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è Mi Tienda en Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-bottom: 70px;
        }
        
        .header {
            background: var(--tg-theme-button-color, #40a7e3);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
        }
        
        .category-btn {
            padding: 10px 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-button-color, #40a7e3);
            border-radius: 25px;
            color: var(--tg-theme-button-color, #40a7e3);
            font-weight: bold;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-btn.active {
            background: var(--tg-theme-button-color, #40a7e3);
            color: white;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .product-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f5f5f5;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .product-desc {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #888888);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #40a7e3);
        }
        
        .add-to-cart {
            background: var(--tg-theme-button-color, #40a7e3);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s;
        }
        
        .add-to-cart:hover {
            background: var(--tg-theme-button-color, #2d96d3);
        }
        
        .cart-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .cart-info {
            flex: 1;
        }
        
        .cart-total {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .cart-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #888888);
        }
        
        .checkout-btn {
            background: var(--tg-theme-button-color, #40a7e3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        
        .cart-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .cart-content {
            background: var(--tg-theme-bg-color, #ffffff);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        
        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--tg-theme-button-color, #40a7e3);
            background: none;
            color: var(--tg-theme-button-color, #40a7e3);
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--tg-theme-hint-color, #888888);
        }
        
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõçÔ∏è Mi Tienda Online</h1>
        <p>¬°Bienvenido! Compra f√°cil y r√°pido</p>
    </div>
    
    <div class="categories">
        <button class="category-btn active" onclick="filterCategory('all')">Todos</button>
        <button class="category-btn" onclick="filterCategory('ropa')">Ropa</button>
        <button class="category-btn" onclick="filterCategory('tech')">Tecnolog√≠a</button>
        <button class="category-btn" onclick="filterCategory('hogar')">Hogar</button>
        <button class="category-btn" onclick="filterCategory('otros')">Otros</button>
    </div>
    
    <div id="products-container" class="products-grid">
        <div class="loading">
            <p>Cargando productos...</p>
        </div>
    </div>
    
    <div class="cart-bottom" id="cart-bottom" style="display: none;">
        <div class="cart-info">
            <div class="cart-total">Total: $<span id="total-price">0</span></div>
            <div class="cart-count"><span id="total-items">0</span> productos en el carrito</div>
        </div>
        <button class="checkout-btn" onclick="openCart()">Ver Carrito</button>
    </div>
    
    <div class="cart-modal" id="cart-modal">
        <div class="cart-content">
            <h2 style="margin-bottom: 20px;">üõí Tu Carrito</h2>
            <div id="cart-items"></div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>Subtotal:</span>
                    <span>$<span id="cart-subtotal">0</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>Env√≠o:</span>
                    <span>$<span id="cart-shipping">5</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold;">
                    <span>Total:</span>
                    <span>$<span id="cart-total">0</span></span>
                </div>
                <button class="checkout-btn" style="width: 100%; margin-top: 20px; padding: 15px;" onclick="checkout()">
                    üí≥ Proceder al Pago
                </button>
                <button onclick="closeCart()" style="width: 100%; margin-top: 10px; padding: 15px; background: none; border: 1px solid var(--tg-theme-button-color, #40a7e3); color: var(--tg-theme-button-color, #40a7e3); border-radius: 10px; cursor: pointer;">
                    Seguir Comprando
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // CONFIGURACI√ìN INICIAL
        // ====================
        
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Productos de ejemplo (luego vendr√°n de una base de datos)
        const productos = [
            {
                id: 1,
                nombre: "Camiseta B√°sica",
                descripcion: "Camiseta 100% algod√≥n, varios colores",
                precio: 19.99,
                categoria: "ropa",
                imagen: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=400&fit=crop"
            },
            {
                id: 2,
                nombre: "Auriculares Bluetooth",
                descripcion: "Sonido premium, 30h bater√≠a",
                precio: 89.99,
                categoria: "tech",
                imagen: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w-400&h=400&fit=crop"
            },
            {
                id: 3,
                nombre: "Taza de Cer√°mica",
                descripcion: "Taza personalizable, 350ml",
                precio: 12.99,
                categoria: "hogar",
                imagen: "https://images.unsplash.com/photo-1514228742587-6b1558fcf93a?w=400&h=400&fit=crop"
            },
            {
                id: 4,
                nombre: "Libro Best Seller",
                descripcion: "Novela m√°s vendida del a√±o",
                precio: 24.99,
                categoria: "otros",
                imagen: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=400&fit=crop"
            },
            {
                id: 5,
                nombre: "Reloj Deportivo",
                descripcion: "Resistente al agua, GPS",
                precio: 199.99,
                categoria: "tech",
                imagen: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop"
            },
            {
                id: 6,
                nombre: "Sudadera con Capucha",
                descripcion: "Algod√≥n org√°nico, tallas S-XXL",
                precio: 39.99,
                categoria: "ropa",
                imagen: "https://images.unsplash.com/photo-1523381210434-271e8be1f52b?w=400&h=400&fit=crop"
            }
        ];
        
        // Carrito de compras
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let categoriaActual = 'all';
        
        // ====================
        // FUNCIONES PRINCIPALES
        // ====================
        
        // Inicializar Telegram WebApp
        function initTelegram() {
            tg.ready();
            tg.expand(); // Expandir pantalla completa
            
            // Configurar bot√≥n principal
            tg.MainButton.setText("PAGAR $0");
            tg.MainButton.hide();
            
            // Mostrar datos del usuario (opcional)
            const user = tg.initDataUnsafe.user;
            if (user) {
                console.log("Usuario:", user);
            }
        }
        
        // Cargar productos en la p√°gina
        function cargarProductos() {
            const container = document.getElementById('products-container');
            
            // Filtrar por categor√≠a
            const productosFiltrados = categoriaActual === 'all' 
                ? productos 
                : productos.filter(p => p.categoria === categoriaActual);
            
            if (productosFiltrados.length === 0) {
                container.innerHTML = '<div class="loading"><p>No hay productos en esta categor√≠a</p></div>';
                return;
            }
            
            // Generar HTML de productos
            container.innerHTML = productosFiltrados.map(producto => `
                <div class="product-card">
                    <img src="${producto.imagen}" alt="${producto.nombre}" class="product-img" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=Producto'">
                    <div class="product-info">
                        <h3 class="product-title">${producto.nombre}</h3>
                        <p class="product-desc">${producto.descripcion}</p>
                        <div class="product-footer">
                            <span class="product-price">$${producto.precio.toFixed(2)}</span>
                            <button class="add-to-cart" onclick="agregarAlCarrito(${producto.id})">
                                +
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Filtrar por categor√≠a
        function filterCategory(categoria) {
            categoriaActual = categoria;
            
            // Actualizar botones activos
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Recargar productos
            cargarProductos();
        }
        
        // Agregar producto al carrito
        function agregarAlCarrito(productoId) {
            const producto = productos.find(p => p.id === productoId);
            
            // Buscar si ya existe en el carrito
            const itemExistente = carrito.find(item => item.id === productoId);
            
            if (itemExistente) {
                itemExistente.cantidad++;
            } else {
                carrito.push({
                    ...producto,
                    cantidad: 1
                });
            }
            
            // Efecto de vibraci√≥n (si Telegram lo permite)
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            // Notificaci√≥n
            tg.showPopup({
                title: "‚úÖ Producto agregado",
                message: `${producto.nombre} se a√±adi√≥ al carrito`,
                buttons: [{ type: "close" }]
            });
            
            // Guardar y actualizar
            guardarCarrito();
            actualizarCarrito();
        }
        
        // Actualizar visual del carrito
        function actualizarCarrito() {
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            const totalPrice = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            // Actualizar contadores
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
            
            // Mostrar/ocultar barra inferior
            const cartBottom = document.getElementById('cart-bottom');
            if (totalItems > 0) {
                cartBottom.style.display = 'flex';
                tg.MainButton.setText(`PAGAR $${totalPrice.toFixed(2)}`);
                tg.MainButton.show();
            } else {
                cartBottom.style.display = 'none';
                tg.MainButton.hide();
            }
            
            // Actualizar bot√≥n de Telegram
            tg.MainButton.onClick = checkout;
        }
        
        // Guardar carrito en localStorage
        function guardarCarrito() {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }
        
        // Abrir modal del carrito
        function openCart() {
            const modal = document.getElementById('cart-modal');
            const cartItems = document.getElementById('cart-items');
            
            if (carrito.length === 0) {
                cartItems.innerHTML = '<div class="loading"><p>El carrito est√° vac√≠o</p></div>';
            } else {
                // Calcular totales
                const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                const shipping = 5.00; // Costo fijo de env√≠o
                const total = subtotal + shipping;
                
                // Generar HTML de items del carrito
                cartItems.innerHTML = carrito.map(item => `
                    <div class="cart-item">
                        <img src="${item.imagen}" alt="${item.nombre}" class="cart-item-img"
                             onerror="this.src='https://via.placeholder.com/60?text=Producto'">
                        <div class="cart-item-info">
                            <h4 style="margin-bottom: 5px;">${item.nombre}</h4>
                            <div>$${item.precio.toFixed(2)} √ó ${item.cantidad}</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn" onclick="cambiarCantidad(${item.id}, -1)">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.cantidad}</span>
                            <button class="quantity-btn" onclick="cambiarCantidad(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `).join('');
                
                // Actualizar totales
                document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2);
                document.getElementById('cart-shipping').textContent = shipping.toFixed(2);
                document.getElementById('cart-total').textContent = total.toFixed(2);
            }
            
            modal.style.display = 'flex';
        }
        
        // Cerrar modal del carrito
        function closeCart() {
            document.getElementById('cart-modal').style.display = 'none';
        }
        
        // Cambiar cantidad de un producto
        function cambiarCantidad(productoId, cambio) {
            const itemIndex = carrito.findIndex(item => item.id === productoId);
            
            if (itemIndex !== -1) {
                carrito[itemIndex].cantidad += cambio;
                
                // Si la cantidad llega a 0, eliminar del carrito
                if (carrito[itemIndex].cantidad <= 0) {
                    carrito.splice(itemIndex, 1);
                }
                
                // Guardar y actualizar
                guardarCarrito();
                actualizarCarrito();
                openCart(); // Recargar modal
            }
        }
        
        // Proceso de pago
        function checkout() {
            if (carrito.length === 0) {
                tg.showAlert("El carrito est√° vac√≠o");
                return;
            }
            
            // Crear resumen del pedido
            const orderSummary = carrito.map(item => 
                `${item.nombre} (x${item.cantidad}) - $${(item.precio * item.cantidad).toFixed(2)}`
            ).join('\n');
            
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            tg.showPopup({
                title: "üí≥ Confirmar Pedido",
                message: `Pedido:\n${orderSummary}\n\nTotal: $${total.toFixed(2)}\n\n¬øConfirmar compra?`,
                buttons: [
                    {id: "confirm", type: "default", text: "‚úÖ Confirmar"},
                    {type: "cancel"}
                ]
            }, (buttonId) => {
                if (buttonId === "confirm") {
                    procesarPago();
                }
            });
        }
        
        // Procesar el pago (simulado)
        function procesarPago() {
            // En un caso real, aqu√≠ enviar√≠as los datos a tu servidor
            const orderData = {
                userId: tg.initDataUnsafe.user?.id || "anon",
                username: tg.initDataUnsafe.user?.username || "sin_usuario",
                productos: carrito,
                total: carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0),
                fecha: new Date().toISOString()
            };
            
            // Simular procesamiento
            tg.showAlert("üîÑ Procesando tu pago...");
            
            setTimeout(() => {
                // Mostrar confirmaci√≥n
                tg.showAlert("‚úÖ ¬°Pedido confirmado! Te contactaremos para el env√≠o.");
                
                // Enviar datos al bot (esto se enviar√° al bot.js)
                tg.sendData(JSON.stringify({
                    action: "new_order",
                    ...orderData
                }));
                
                // Limpiar carrito
                carrito = [];
                guardarCarrito();
                actualizarCarrito();
                closeCart();
                
            }, 2000);
        }
        
        // ====================
        // INICIALIZACI√ìN
        // ====================
        
        // Cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', () => {
            initTelegram();
            cargarProductos();
            actualizarCarrito();
        });
        
        // Cerrar modal al hacer click fuera
        document.getElementById('cart-modal').addEventListener('click', (e) => {
            if (e.target.id === 'cart-modal') {
                closeCart();
            }
        });
    </script>
</body>
</html>
